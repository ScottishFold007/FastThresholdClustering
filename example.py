import re
import json
import torch
import pandas as pd
import matplotlib.pyplot as plt
from sentence_transformers import SentenceTransformer, util
from import fast_cluster_embeddings

# Model for computing sentence embeddings.
model = SentenceTransformer("./m3e_nli_triple_large")

# df形如：	
```
问题
0	请详细介绍许家小母马的来历、特点及其在小说中的地位。
1	许七安是如何获得小母马的？这匹马在许家有什么特殊意义？
2	作者是如何通过小母马这个非人物角色来丰富小说内容的？这种写作手法有什么效果？
3	请详细描述平阳郡主的身份、外貌特征以及性格特点，并说明她的遭遇。
```
df= pd.read_excel("test1.xlsx")
df.drop_duplicates(subset= ["问题"], inplace= True)

print("Encode the corpus. This might take a while")
corpus_sentences= df["问题"].tolist()
corpus_embeddings = model.encode(corpus_sentences, batch_size=64, show_progress_bar=True, convert_to_tensor=False)


recommended_nprobe= get_recommended_nprobe(n_samples= corpus_embeddings.shape[0])
print(f"Recommended Nprobe: {recommended_nprobe}")

labels = fast_cluster_embeddings(
    corpus_embeddings,
    similarity_threshold= 0.60,
    min_samples= 25,
    use_gpu= False,
    nprobe= 32,
    batch_size= 16,
    n_workers = 8
)
cluster_df= pd.DataFrame({"sentence": corpus_sentences, "label": labels})
cluster_df= cluster_df[cluster_df["label"]!=-1]

# 按label聚合sentence
grouped_df = cluster_df.groupby('label')['sentence'].agg(list).reset_index()

# 按label排序
grouped_df = grouped_df.sort_values('label')
# 打印结果
for _, row in grouped_df.iterrows():
    print(f"Label {row['label']}:")
    for sentence in row['sentence']:
        print(f"  - {sentence}")
    print()
```
Results:
Label 0:
  - 请详细介绍许家小母马的来历、特点及其在小说中的地位。
  - 许七安是如何获得小母马的？这匹马在许家有什么特殊意义？
  - 小母马在《大奉打更人》中的身份和重要性如何？它与许七安和许平志的关系是怎样的？
  - 小母马的外形特征和在故事中的地位如何？它为什么会被读者称为'女主角'？
  - 小母马从许平志转赠给许七安的过程有何意义？这种传承如何影响故事发展和人物关系？
  - 小母马在《大奉打更人》中的角色定位和特点是什么？
  - 小母马如何影响了《大奉打更人》中的人物关系和情节发展？
  - 小母马在《大奉打更人》中被读者称为'女主角'的原因是什么？这种称呼反映了什么？
  - 《大奉打更人》在起点中文网创造了哪些记录？同时，请介绍小说中'小母马'这个特殊角色的来历和地位。
  - 小母马在《大奉打更人》中的所有权变化和特殊地位是怎样的？
  - 小母马作为《大奉打更人》中的特殊'物品'，它有哪些独特之处？
  - 小母马在《大奉打更人》的故事发展和角色塑造中扮演了什么角色？
  - 请详细介绍小母马的来历、特征及其在小说中的地位。
  - 小母马在许七安和许平志之间扮演了什么角色？它在小说中可能有什么象征意义？
  - 读者将小母马称为'女主角'这一现象反映了什么？这对理解作者的写作风格有何启示？
  - 许平志与许七安、小母马之间有什么关系？这些关系反映了许平志的什么特点？
  - 请详细介绍《大奉打更人》中小母马的特点、来历和在小说中的地位。
  - 小母马在许七安和许平志之间扮演了什么角色？它作为坐骑有什么特别之处？
  - 为什么读者会将小母马戏称为'女主角'？这种称呼反映了小说创作的哪些特点？
  - 请详细介绍许家小母马的来历、特征及在小说中的地位。
  - 许七安是如何获得小母马的？这对许家成员关系有何影响？
  - 请详细介绍《大奉打更人》中小母马的特征、来历和在故事中的地位。
  - 小母马如何影响了《大奉打更人》中许七安和许平志的关系，以及它在故事发展中可能扮演的角色？
  - 许七安的坐骑小母马有什么来历？
  - 许七安的小母马有什么特点?
  - 许家小母马有什么特点？
  - 小母马原来是谁的坐骑？
  - 许七安和小母马是什么关系?
  - 许家的小母马有什么特别之处吗？
  - 许家的小母马有什么来历？
  - 为什么许七安的小母马被网友戏称为女主
  - 在云州案中许七安的成长与他的坐骑小母马有什么关联?
  - 小母马和许平志是什么关系？
...

Label 1:
  - 请详细描述平阳郡主的身份、外貌特征以及性格特点，并说明她的遭遇。
  - 恒慧与恒远、平阳郡主之间的关系如何？这些关系对他的人生轨迹有何影响？
  - 请详细描述平阳郡主的外貌特征和她的悲剧遭遇，并分析这些因素如何塑造了她的形象。
  - 请详细描述恒慧和平阳郡主的爱情故事，以及他们的悲剧结局是如何发生的？
  - 平阳郡主的身份背景是什么？她和恒慧的私奔事件背后有什么政治因素？
  - 恒远、恒慧和平阳郡主之间有什么关系？他们各自的命运如何？
  - 平阳郡主的遭遇反映了什么样的社会问题？请结合她的身份背景和具体经历分析。
  - 请详细介绍平阳郡主的身份背景、恋情以及与其他人物的关系。
  - 平阳郡主的悲剧经历了哪些关键事件，最终结局如何？
  - 从平阳郡主的行为和结局中，我们可以看出她具有怎样的性格特点？
  - 请详细介绍平阳郡主的身份背景、恋情经历以及最终的悲剧结局。
  - 平阳郡主与恒慧的恋情涉及哪些复杂的人物关系和政治因素？这段关系最终如何影响了他们的命运？
  - 请详细描述恒慧和平阳郡主的爱情故事及其悲剧性结局。
  - 平阳郡主的身份背景如何，她与恒慧的私奔事件背后有什么政治因素？
  - 恒慧和平阳郡主私奔后经历了哪些事情，最终结局如何？
  - 请详细介绍平阳郡主的身份背景、恋情经历及其悲剧结局。
  - 结合平阳郡主的穿着、行为和结局，分析她的性格特点和人物形象。
  - 临安与王妃有什么关系?
  - 平阳郡主与谁相恋？最后的结局如何？
  - 平阳郡主与恒慧私奔是怎么回事？
  - 平阳郡主和恒慧是什么样的情感关系？
  - 平阳郡主之死是怎么被查明真相的？
  - 平阳郡主私奔和誉王之死有什么联系？
  - 平阳郡主与长公主之间是什么关系？
  - 平阳郡主在与恒慧相恋时有哪些表现？
  - 平阳郡主的最终命运是什么
  - 平阳郡主有哪些特点？
  - 平阳郡主是怎么死亡的?
  - 平阳郡主的感情经历是怎样的？
  - 平阳郡主的身份有哪些特殊之处？
  - 第十四集中临安为什么要向王妃隐瞒平阳失踪一事？
  - 永兴帝与临安公主是什么关系？
  - 平阳郡主和恒慧相恋后发生了什么?
  - 平阳郡主有什么遭遇?
...

Label 2:
  - 临安公主的性格特点是什么？这些特点如何在她的行为中体现出来？
  - 请对比分析平阳郡主和临安公主的性格特点及其在故事中的表现。
  - 临安公主的性格特点和外貌特征如何体现她的皇室身份和个人魅力？
  - 比较临安公主与平阳郡主的特点，并分析临安公主的性格特征可能带来的成长潜力和挑战？
  - 请比较平阳郡主和临安的性格特点，并分析她们的皇室背景对其性格形成的影响。
  - 临安的哪些行为体现了她的性格特点？这些特点如何影响她与其他人物的互动？
  - 请详细描述临安的外貌特征和性格特点，并说明她在皇室中的地位。
  - 请比较平阳郡主和临安的外貌特征，并说明临安的家庭背景。
  - 请详细描述并比较丽娜和临安元景帝次女的外貌特征。
  - 请比较平阳郡主、闻人倩柔和姬谦的外貌特征，并分析他们的形象给人的印象。
...


..
```

